<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-User Video Call</title>
<style>
body { font-family: sans-serif; text-align: center; padding: 20px; background: #e6ecf0; }
h2 { font-size: 24px; margin-bottom: 15px; }
input { padding:8px; font-size:16px; margin:5px; }
button { padding: 12px 18px; margin: 5px; font-size: 16px; border-radius: 10px; border: none; cursor: pointer; box-shadow: 0 4px #999; }
button:active { box-shadow: 0 2px #666; transform: translateY(2px); }
#incomingCall { display: none; background: #fff; padding: 20px; border-radius: 15px; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
#callControls { display: none; margin-top: 20px; }
#callStatus, #callTimer { font-size: 18px; margin-top: 10px; }
video { border-radius: 10px; margin-top: 10px; max-width: 100%; }
#localVideo { width: 120px; height: 160px; position: absolute; top: 20px; right: 20px; border: 2px solid #333; }
#userList { margin-top: 20px; background: #fff; padding: 10px; border-radius: 10px; max-height:200px; overflow-y:auto; }
.userItem { padding: 8px; border-bottom: 1px solid #ddd; cursor: pointer; }
.userItem:hover { background: #f0f0f0; }
</style>
</head>
<body>

<h2>ğŸ“¹ Multi-User Video Call</h2>

<input type="text" id="username" placeholder="Enter Your Name">
<br>
<button onclick="registerUser()">âœ… Go Online</button>

<div id="userList"></div>

<div id="incomingCall">
  <h3>Incoming Call from <span id="incomingCaller">Unknown</span></h3>
  <button onclick="acceptCall()">âœ… Accept</button>
  <button onclick="rejectCall()">âŒ Reject</button>
</div>

<div id="callControls">
  <button id="muteBtn" onclick="toggleMute()">ğŸ¤ Mute</button>
  <button id="videoBtn" onclick="toggleVideo()">ğŸ“¹ Video Off</button>
  <button id="speakerBtn" onclick="toggleSpeaker()">ğŸ”Š Speaker</button>
  <div id="callTimer">00:00</div>
  <button onclick="endCall()">âŒ End Call</button>
</div>

<video id="remoteVideo" autoplay playsinline></video>
<video id="localVideo" autoplay muted playsinline></video>
<audio id="ringtone" src="https://actions.google.com/sounds/v1/alarms/phone_alerts_and_rings.ogg" loop></audio>
<div id="callStatus">Call Status: None</div>

<input type="hidden" id="targetId">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, remove, onDisconnect, push } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDQDrOlYu4GFuba1v1PJGlyLSIEm6Li6No",
  authDomain: "bongocall-cad70.firebaseapp.com",
  databaseURL: "https://bongocall-cad70-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "bongocall-cad70",
  storageBucket: "bongocall-cad70.firebasestorage.app",
  messagingSenderId: "642949206020",
  appId: "1:642949206020:web:7329857025880de0446551"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// User ID
let userId = localStorage.getItem("userId");
if(!userId){
  userId = 'user-' + Math.floor(Math.random()*1000000);
  localStorage.setItem("userId", userId);
}

// Variables
let peer=null, localStream=null, callId=null;
let isMuted=false, isVideoOn=true, isSpeakerOn=true, callSeconds=0, timerInterval=null;

// Elements
const remoteVideo = document.getElementById("remoteVideo");
const localVideo = document.getElementById("localVideo");
const ringtone = document.getElementById("ringtone");
const userListDiv = document.getElementById("userList");

// Timer
function startTimer() {
  callSeconds = 0;
  document.getElementById("callTimer").innerText="00:00";
  timerInterval = setInterval(()=>{
    callSeconds++;
    let m = String(Math.floor(callSeconds/60)).padStart(2,"0");
    let s = String(callSeconds%60).padStart(2,"0");
    document.getElementById("callTimer").innerText=`${m}:${s}`;
  },1000);
}
function stopTimer(){ clearInterval(timerInterval); }

// Go Online and listen to users
window.registerUser = ()=>{
  const name=document.getElementById("username").value||"Unknown";
  set(ref(db,"users/"+userId),{name,online:true});
  onDisconnect(ref(db,"users/"+userId)).remove();

  onValue(ref(db,"users"), snap=>{
    const users = snap.val()||{};
    userListDiv.innerHTML='';
    for(const id in users){
      if(id===userId) continue;
      const div=document.createElement("div");
      div.className="userItem";
      div.textContent=users[id].name+" ("+id+")";
      div.onclick=()=>document.getElementById("targetId").value=id;
      userListDiv.appendChild(div);
    }
  });
};

// Start Call
window.startCall = async ()=>{
  const targetId=document.getElementById("targetId").value;
  const name=document.getElementById("username").value||"Unknown";
  if(!targetId){ alert("Select user to call"); return; }

  localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:true});
  localVideo.srcObject=localStream;

  callId=userId+"_"+targetId;
  peer=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  localStream.getTracks().forEach(track=>peer.addTrack(track,localStream));

  peer.ontrack=e=>remoteVideo.srcObject=e.streams[0];
  peer.onicecandidate=e=>{ if(e.candidate) push(ref(db,"calls/"+callId+"/candidates"),e.candidate); };

  const offer=await peer.createOffer();
  await peer.setLocalDescription(offer);
  set(ref(db,"calls/"+callId+"/offer"),{offer,callerId:userId,callerName:name,targetId});
  set(ref(db,"calls/"+callId+"/status"),"calling");
  document.getElementById("callStatus").innerText="Calling "+targetId;
};

// Listen for incoming calls
onValue(ref(db,"calls"), snap=>{
  const calls = snap.val()||{};
  for(const key in calls){
    const c=calls[key];
    if(c.status==="calling" && c.targetId===userId){
      document.getElementById("incomingCaller").textContent=c.callerName;
      document.getElementById("incomingCall").style.display="block";
      ringtone.play().catch(()=>{});
      callId=key;
    }
  }
});

// Accept Call
window.acceptCall=async ()=>{
  document.getElementById("incomingCall").style.display="none";
  ringtone.pause(); ringtone.currentTime=0;

  localStream=await navigator.mediaDevices.getUserMedia({audio:true,video:true});
  localVideo.srcObject=localStream;

  peer=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  localStream.getTracks().forEach(track=>peer.addTrack(track,localStream));

  peer.ontrack=e=>remoteVideo.srcObject=e.streams[0];
  peer.onicecandidate=e=>{ if(e.candidate) push(ref(db,"calls/"+callId+"/candidates"),e.candidate); };

  onValue(ref(db,"calls/"+callId+"/offer"), async snap=>{
    const data=snap.val();
    if(!data) return;
    await peer.setRemoteDescription(data.offer);
    const answer=await peer.createAnswer();
    await peer.setLocalDescription(answer);
    set(ref(db,"calls/"+callId+"/answer"),{answer,targetId:userId});
    set(ref(db,"calls/"+callId+"/status"),"in-call");
    document.getElementById("callControls").style.display="block";
    startTimer();
  });

  onValue(ref(db,"calls/"+callId+"/candidates"), snap=>{
    snap.forEach(child=>peer.addIceCandidate(new RTCIceCandidate(child.val())));
  });
};

// Reject Call
window.rejectCall=()=>{ if(callId) remove(ref(db,"calls/"+callId)); document.getElementById("incomingCall").style.display="none"; ringtone.pause(); ringtone.currentTime=0; alert("Call Rejected"); };

// End Call
window.endCall=()=>{ if(peer) peer.close(); if(callId) remove(ref(db,"calls/"+callId)); stopTimer(); document.getElementById("callControls").style.display="none"; document.getElementById("callStatus").innerText="Call Ended"; };

// Mute
window.toggleMute=()=>{ if(!localStream) return; localStream.getAudioTracks().forEach(track=>track.enabled=isMuted); isMuted=!isMuted; document.getElementById("muteBtn").innerText=isMuted?"ğŸ¤ Unmute":"ğŸ¤ Mute"; };

// Video
window.toggleVideo=()=>{ if(!localStream) return; localStream.getVideoTracks().forEach(track=>track.enabled=isVideoOn); isVideoOn=!isVideoOn; document.getElementById("videoBtn").innerText=isVideoOn?"ğŸ“¹ Video Off":"ğŸ“¹ Video On"; };

// Speaker
window.toggleSpeaker=async()=>{ isSpeakerOn=!isSpeakerOn; remoteVideo.volume=isSpeakerOn?1:0; document.getElementById("speakerBtn").innerText=isSpeakerOn?"ğŸ”Š Speaker":"ğŸ”‡ Speaker"; };

</script>

<input type="hidden" id="targetId">
</body>
</html>