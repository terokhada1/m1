<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stranger Group - Fixed Controls</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --primary: #238636; --danger: #da3633; --accent: #2f81f7; }
        
        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg); 
            color: white; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            height: -webkit-fill-available;
            overflow: hidden; 
        }

        /* Home Screen */
        #home-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .mode-card { background: var(--card); padding: 40px 20px; border-radius: 24px; border: 1px solid var(--border); text-align: center; width: 85%; max-width: 350px; }

        /* Video Area */
        #main-container { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; position: relative; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; padding: 10px; overflow-y: auto; flex-grow: 1; }
        .video-box { position: relative; background: #000; border-radius: 16px; overflow: hidden; aspect-ratio: 1/1; border: 1px solid var(--border); }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* Overlay Status */
        .status-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        .status-overlay.active { display: flex; }
        .status-text { color: var(--danger); font-weight: bold; }

        /* FIXED BOTTOM CONTROLS */
        .controls { 
            background: #161b22; 
            padding: 15px 10px 25px 10px; /* Extra bottom padding for mobile notches */
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            border-top: 1px solid var(--border);
            z-index: 100;
        }

        .btn { 
            width: 55px; 
            height: 55px; 
            border-radius: 50%; 
            border: none; 
            cursor: pointer; 
            background: #30363d; 
            color: white; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            font-size: 20px;
            transition: all 0.2s ease;
        }

        .btn span { font-size: 9px; margin-top: 2px; font-weight: bold; }
        .btn.active-off { background: var(--danger) !important; }
        .btn-leave { background: var(--danger); width: 65px; border-radius: 15px; }

        /* Sidebar Chat */
        #chat-sidebar { position: absolute; top: 0; right: 0; bottom: 0; width: 80%; background: var(--card); z-index: 200; border-left: 1px solid var(--border); transform: translateX(100%); transition: 0.3s ease; }
        #chat-sidebar.open { transform: translateX(0); }
        #messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 15px; max-width: 80%; font-size: 14px; }
        .msg.you { align-self: flex-end; background: var(--accent); }
        .msg.str { align-self: flex-start; background: var(--border); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="mode-card">
            <h2>Stranger Chat</h2>
            <button class="btn" style="width:100%; border-radius:12px; margin-bottom:10px; background:var(--accent)" onclick="startApp('video')">ðŸ“¹ Video Chat</button>
            <button class="btn" style="width:100%; border-radius:12px; background:var(--primary)" onclick="startApp('audio')">ðŸŽ¤ Audio Only</button>
        </div>
    </div>

    <div id="main-container">
        <div id="video-grid">
            <div class="video-box" id="localBox">
                <video id="localVideo" autoplay muted playsinline></video>
                <div id="audio-only-ui" class="status-overlay">ðŸŽ¤ Audio Mode</div>
            </div>
        </div>

        <div id="chat-sidebar">
            <div id="messages"></div>
            <div style="padding:10px; display:flex; gap:5px; border-top:1px solid var(--border)">
                <input type="text" id="msgInput" style="flex:1; padding:10px; border-radius:8px; border:none; background:#000; color:white;">
                <button onclick="sendChat()" style="background:var(--accent); border:none; color:white; border-radius:8px; padding:0 15px;">Send</button>
            </div>
        </div>
    </div>

    <div id="actionButtons" class="controls hidden">
        <button id="micBtn" class="btn" onclick="toggleMic()">ðŸŽ¤<span>Mic</span></button>
        <button id="camBtn" class="btn" onclick="toggleCam()">ðŸ“·<span>Cam</span></button>
        <button id="chatBtn" class="btn" onclick="toggleChat()">ðŸ’¬<span>Chat</span></button>
        <button class="btn btn-leave" onclick="location.reload()">âœ–<span>Exit</span></button>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, push, onChildAdded, onChildRemoved, get, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDQDrOlYu4GFuba1v1PJGlyLSIEm6Li6No",
    authDomain: "bongocall-cad70.firebaseapp.com",
    databaseURL: "https://bongocall-cad70-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bongocall-cad70",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const userId = 'User-' + Math.floor(Math.random() * 9000);
const iceServers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
let localStream, currentRoomId, peers = {};

window.startApp = async (mode) => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: mode === 'video' });
        document.getElementById("localVideo").srcObject = localStream;
        if(mode === 'audio') {
            document.getElementById("audio-only-ui").classList.add("active");
            document.getElementById("camBtn").classList.add("hidden");
        }
        document.getElementById("home-screen").classList.add("hidden");
        document.getElementById("actionButtons").classList.remove("hidden");
        findRoom();
    } catch (e) { alert("Enable camera/mic!"); }
};

async function findRoom() {
    const snap = await get(ref(db, 'rooms'));
    const rooms = snap.val() || {};
    currentRoomId = Object.keys(rooms).find(id => Object.keys(rooms[id].users || {}).length < 4) || 'Room-' + Date.now();
    
    await set(ref(db, `rooms/${currentRoomId}/users/${userId}`), { id: userId });
    onDisconnect(ref(db, `rooms/${currentRoomId}/users/${userId}`)).remove();

    onChildAdded(ref(db, `rooms/${currentRoomId}/users`), (s) => { if(s.key !== userId) createPeer(s.key, true); });
    onChildRemoved(ref(db, `rooms/${currentRoomId}/users`), (s) => {
        if(peers[s.key]) { peers[s.key].close(); delete peers[s.key]; document.getElementById(`status-${s.key}`)?.classList.add('active'); }
    });
    onChildAdded(ref(db, `rooms/${currentRoomId}/chat`), (s) => addMsg(s.val()));

    onChildAdded(ref(db, `rooms/${currentRoomId}/signals/${userId}`), async (s) => {
        const d = s.val(); if(!peers[d.from]) createPeer(d.from, false);
        const pc = peers[d.from];
        if(d.type === 'offer') {
            await pc.setRemoteDescription(new RTCSessionDescription(d));
            const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
            push(ref(db, `rooms/${currentRoomId}/signals/${d.from}`), { from:userId, type:'answer', sdp:ans.sdp });
        } else if(d.type === 'answer') { await pc.setRemoteDescription(new RTCSessionDescription(d)); }
        else if(d.candidate) { await pc.addIceCandidate(new RTCIceCandidate(d.candidate)); }
    });
}

function createPeer(rid, isCaller) {
    const pc = new RTCPeerConnection(iceServers); peers[rid] = pc;
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    pc.onicecandidate = (e) => { if(e.candidate) push(ref(db, `rooms/${currentRoomId}/signals/${rid}`), { from:userId, candidate:e.candidate.toJSON() }); };
    pc.ontrack = (e) => {
        if(document.getElementById(`vid-${rid}`)) return;
        const box = document.createElement("div"); box.className = "video-box"; box.id = `box-${rid}`;
        box.innerHTML = `<video id="vid-${rid}" autoplay playsinline></video><div class="status-overlay" id="status-${rid}">Stranger Left</div>`;
        document.getElementById("video-grid").appendChild(box);
        document.getElementById(`vid-${rid}`).srcObject = e.streams[0];
    };
    if(isCaller) {
        pc.onnegotiationneeded = async () => {
            const off = await pc.createOffer(); await pc.setLocalDescription(off);
            push(ref(db, `rooms/${currentRoomId}/signals/${rid}`), { from:userId, type:'offer', sdp:off.sdp });
        };
    }
}

// Fixed Button Logic
window.toggleMic = () => {
    const track = localStream.getAudioTracks()[0];
    track.enabled = !track.enabled;
    document.getElementById("micBtn").classList.toggle("active-off", !track.enabled);
};

window.toggleCam = () => {
    const track = localStream.getVideoTracks()[0];
    if(track) {
        track.enabled = !track.enabled;
        document.getElementById("camBtn").classList.toggle("active-off", !track.enabled);
    }
};

window.toggleChat = () => {
    document.getElementById("chat-sidebar").classList.toggle("open");
    document.getElementById("chatBtn").classList.toggle("active-off", document.getElementById("chat-sidebar").classList.contains("open"));
};

window.sendChat = () => {
    const val = document.getElementById("msgInput").value;
    if(val) { push(ref(db, `rooms/${currentRoomId}/chat`), { user:userId, text:val }); document.getElementById("msgInput").value = ""; }
};

function addMsg(d) {
    const div = document.createElement("div"); div.className = `msg ${d.user === userId ? 'you' : 'str'}`;
    div.innerText = d.text; document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}
</script>
</body>
</html>
