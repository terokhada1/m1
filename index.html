<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶≠‡ßü‡ßá‡¶∏ ‡¶ì ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∞‡ßÅ‡¶Æ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; }
        .container { width: 100%; max-width: 500px; background: #1e293b; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); text-align: center; margin-top: 20px; }
        
        #video-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        video { width: 100%; border-radius: 12px; background: #000; object-fit: cover; height: 150px; display: none; border: 2px solid #334155; }
        #localVideo { border-color: #0ea5e9; }

        input { width: 85%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: none; background: #334155; color: white; font-size: 16px; outline: none; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px; color: white; }
        
        .btn-join { background: #0ea5e9; width: 100%; font-size: 16px; }
        .btn-tool { background: #475569; }
        .btn-danger { background: #ef4444; grid-column: span 2; margin-top: 10px; }
        .active-tool { background: #0ea5e9; }

        #user-list { text-align: left; background: #0f172a; padding: 10px; border-radius: 10px; margin-top: 15px; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: #0ea5e9; margin-bottom: 5px;">‡¶≠‡ßü‡ßá‡¶∏ ‡¶ì ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∞‡ßÅ‡¶Æ</h2>
    
    <div id="setup-screen">
        <input type="text" id="roomInput" placeholder="‡¶∞‡ßÅ‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
        <button class="btn-join" onclick="joinRoom()">‡¶∞‡ßÅ‡¶Æ‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div id="call-screen" style="display: none;">
        <div id="video-grid">
            <video id="localVideo" autoplay muted playsinline></video>
            </div>

        <div id="user-list">‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ: <span id="user-count">‡ßß</span> ‡¶ú‡¶®</div>

        <div class="controls">
            <button id="muteBtn" class="btn-tool" onclick="toggleMute()">üé§ ‡¶Æ‡¶æ‡¶á‡¶ï ‡¶ö‡¶æ‡¶≤‡ßÅ</button>
            <button id="camBtn" class="btn-tool" onclick="toggleCamera()">üì∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¨‡¶®‡ßç‡¶ß</button>
            <button id="speakerBtn" class="btn-tool" onclick="toggleSpeaker()">üîä ‡¶∏‡ßç‡¶™‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ</button>
            <button class="btn-tool" onclick="location.reload()">üîÑ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂</button>
            <button class="btn-danger" onclick="leaveRoom()">‚ùå ‡¶ï‡¶≤ ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
</div>

<div id="remote-media-container"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDQDrOlYu4GFuba1v1PJGlyLSIEm6Li6No",
    authDomain: "bongocall-cad70.firebaseapp.com",
    databaseURL: "https://bongocall-cad70-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bongocall-cad70",
    storageBucket: "bongocall-cad70.firebasestorage.app",
    messagingSenderId: "642949206020",
    appId: "1:642949206020:web:7329857025880de0446551"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const myId = 'u-' + Math.floor(Math.random() * 10000);

let myStream, currentRoom, peers = {}, isCamOn = false;

const servers = { iceServers: [{ urls: ["stun:stun1.l.google.com:19302", "stun:stun2.l.google.com:19302"] }] };

window.joinRoom = async () => {
    const room = document.getElementById("roomInput").value.trim().toLowerCase();
    if (!room) return alert("‡¶∞‡ßÅ‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®");
    currentRoom = room;

    // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶è‡¶¨‡¶Ç ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® (‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Ö‡¶´ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá)
    myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
    document.getElementById("localVideo").srcObject = myStream;
    myStream.getVideoTracks().forEach(t => t.enabled = false); // ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶Ö‡¶´

    document.getElementById("setup-screen").style.display = "none";
    document.getElementById("call-screen").style.display = "block";

    const myRef = ref(db, `rooms/${currentRoom}/users/${myId}`);
    set(myRef, { id: myId, joinedAt: Date.now() });
    onDisconnect(myRef).remove();

    onValue(ref(db, `rooms/${currentRoom}/users`), snap => {
        const users = snap.val() || {};
        document.getElementById("user-count").innerText = Object.keys(users).length;
        Object.keys(users).forEach(uid => {
            if (uid !== myId && !peers[uid]) {
                const isCaller = users[uid].joinedAt > users[myId].joinedAt;
                setupPeer(uid, isCaller);
            }
        });
    });

    listenForSignaling();
};

async function setupPeer(targetId, isCaller) {
    const pc = new RTCPeerConnection(servers);
    peers[targetId] = pc;

    myStream.getTracks().forEach(track => pc.addTrack(track, myStream));

    pc.ontrack = (event) => {
        let v = document.getElementById(`vid-${targetId}`);
        if (!v) {
            v = document.createElement("video");
            v.id = `vid-${targetId}`;
            v.autoplay = true;
            v.playsinline = true;
            v.style.display = "block"; // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶¨‡¶æ ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶Ø‡¶æ‡¶á ‡¶π‡ßã‡¶ï ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá‡¶á
            document.getElementById("video-grid").appendChild(v);
        }
        v.srcObject = event.streams[0];
    };

    pc.onicecandidate = e => {
        if (e.candidate) push(ref(db, `rooms/${currentRoom}/signals/${targetId}/${myId}/ice`), e.candidate.toJSON());
    };

    if (isCaller) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        set(ref(db, `rooms/${currentRoom}/signals/${myId}/${targetId}/offer`), { sdp: offer.sdp, type: offer.type });
    }
}

function listenForSignaling() {
    onValue(ref(db, `rooms/${currentRoom}/signals`), snap => {
        const signals = snap.val() || {};
        for (let sId in signals) {
            if (sId === myId) continue;
            const myIncoming = signals[sId][myId];
            if (!myIncoming) continue;
            const pc = peers[sId];
            if (!pc) continue;

            if (myIncoming.offer && !pc.currentRemoteDescription) {
                pc.setRemoteDescription(new RTCSessionDescription(myIncoming.offer)).then(async () => {
                    const ans = await pc.createAnswer();
                    await pc.setLocalDescription(ans);
                    set(ref(db, `rooms/${currentRoom}/signals/${myId}/${sId}/answer`), { sdp: ans.sdp, type: ans.type });
                });
            }
            if (myIncoming.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(myIncoming.answer));
            if (myIncoming.ice) Object.values(myIncoming.ice).forEach(c => pc.addIceCandidate(new RTCIceCandidate(c)).catch(()=>{}));
        }
    });
}

// --- ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
window.toggleMute = () => {
    const t = myStream.getAudioTracks()[0];
    t.enabled = !t.enabled;
    document.getElementById("muteBtn").innerText = t.enabled ? "üé§ ‡¶Æ‡¶æ‡¶á‡¶ï ‡¶ö‡¶æ‡¶≤‡ßÅ" : "üîá ‡¶Æ‡¶æ‡¶á‡¶ï ‡¶¨‡¶®‡ßç‡¶ß";
    document.getElementById("muteBtn").classList.toggle("active-tool", !t.enabled);
};

window.toggleCamera = () => {
    isCamOn = !isCamOn;
    const t = myStream.getVideoTracks()[0];
    t.enabled = isCamOn;
    document.getElementById("localVideo").style.display = isCamOn ? "block" : "none";
    document.getElementById("camBtn").innerText = isCamOn ? "üì∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ" : "üì∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¨‡¶®‡ßç‡¶ß";
    document.getElementById("camBtn").classList.toggle("active-tool", isCamOn);
};

window.toggleSpeaker = () => {
    const audios = document.querySelectorAll("video");
    const isMuted = audios[0] && audios[0].muted;
    audios.forEach(a => { if(a.id !== "localVideo") a.muted = !a.muted; a.volume = 1; });
    document.getElementById("speakerBtn").innerText = isMuted ? "üîä ‡¶∏‡ßç‡¶™‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ" : "üîà ‡¶∏‡ßç‡¶™‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß";
};

window.leaveRoom = () => location.reload();
</script>
</body>
</html>
