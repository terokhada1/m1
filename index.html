<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stranger Group - Video Only</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --primary: #238636; --danger: #da3633; --accent: #2f81f7; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* Home Screen */
        #home-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .mode-card { background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid var(--border); text-align: center; width: 80%; max-width: 350px; }

        /* Video Area */
        #main-container { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; position: relative; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; padding: 10px; overflow-y: auto; align-content: start; }
        .video-box { position: relative; background: #000; border-radius: 12px; overflow: hidden; aspect-ratio: 3/4; border: 1px solid var(--border); }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* Controls */
        .controls { background: #161b22; padding: 10px 5px 25px 5px; display: flex; justify-content: center; gap: 8px; border-top: 1px solid var(--border); }
        .btn { width: 52px; height: 52px; border-radius: 50%; border: none; cursor: pointer; background: #30363d; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 18px; }
        .btn span { font-size: 8px; margin-top: 2px; }
        .btn.off { background: var(--danger) !important; }
        .btn-leave { background: var(--danger); width: 60px; border-radius: 12px; }

        #chat-sidebar { position: absolute; inset: 0; background: var(--card); z-index: 500; display: none; flex-direction: column; }
        #chat-sidebar.open { display: flex; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="mode-card">
            <h2 style="margin-top:0">Stranger Video</h2>
            <p style="color: #8b949e;">Meet people face-to-face</p>
            <button class="btn" style="width:100%; border-radius:12px; background:var(--accent); font-size: 1.1rem; height: 50px;" onclick="startApp()">ðŸ“¹ Start Video Chat</button>
        </div>
    </div>

    <div id="main-container">
        <div id="video-grid">
            <div class="video-box" id="localBox">
                <video id="localVideo" autoplay muted playsinline></video>
                <div style="position:absolute; bottom:5px; left:5px; font-size:10px; background:rgba(0,0,0,0.5); padding:2px 5px; border-radius:4px;">You</div>
            </div>
        </div>

        <div id="chat-sidebar">
            <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:bold;">Group Chat</span>
                <button onclick="toggleChat()" style="background:#30363d; border:none; color:white; border-radius:50%; width:30px; height:30px;">âœ•</button>
            </div>
            <div id="messages" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px;"></div>
            <div style="padding:10px; display:flex; gap:5px; border-top:1px solid var(--border); background:var(--card);">
                <input type="text" id="msgInput" style="flex:1; padding:12px; border-radius:8px; border:none; background:#000; color:white;" placeholder="Type here...">
                <button onclick="sendChat()" style="background:var(--accent); border:none; color:white; border-radius:8px; padding:0 15px; font-weight:bold;">Send</button>
            </div>
        </div>
    </div>

    <div id="actionButtons" class="controls hidden">
        <button id="micBtn" class="btn" onclick="toggleMic()">ðŸŽ¤<span>Mic</span></button>
        <button id="camBtn" class="btn" onclick="toggleCam()">ðŸ“·<span>Cam</span></button>
        <button id="flipBtn" class="btn" onclick="flipCamera()">ðŸ”„<span>Flip</span></button>
        <button id="chatBtn" class="btn" onclick="toggleChat()">ðŸ’¬<span>Chat</span></button>
        <button class="btn btn-leave" onclick="location.reload()">âœ–<span>Exit</span></button>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, push, onChildAdded, onChildRemoved, get, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDQDrOlYu4GFuba1v1PJGlyLSIEm6Li6No",
    authDomain: "bongocall-cad70.firebaseapp.com",
    databaseURL: "https://bongocall-cad70-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bongocall-cad70",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const userId = 'User-' + Math.floor(Math.random() * 9000);
const iceServers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

let localStream, currentRoomId, peers = {}, currentFacingMode = "user";

// Fix for black screen (Auto-play logic)
const setupVideo = (videoEl, stream) => {
    videoEl.srcObject = stream;
    videoEl.onloadedmetadata = () => {
        videoEl.play().catch(e => console.error("Play error:", e));
    };
};

window.startApp = async () => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ 
            audio: true, 
            video: { facingMode: currentFacingMode } 
        });
        setupVideo(document.getElementById("localVideo"), localStream);
        
        document.getElementById("home-screen").style.display = "none";
        document.getElementById("actionButtons").classList.remove("hidden");
        findRoom();
    } catch (e) { alert("Camera Access Denied!"); }
};

window.flipCamera = async () => {
    if (!localStream) return;
    const oldTrack = localStream.getVideoTracks()[0];
    currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
    
    const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
    const newTrack = newStream.getVideoTracks()[0];

    localStream.removeTrack(oldTrack);
    oldTrack.stop();
    localStream.addTrack(newTrack);
    
    document.getElementById("localVideo").srcObject = localStream;

    Object.values(peers).forEach(pc => {
        const sender = pc.getSenders().find(s => s.track.kind === 'video');
        if (sender) sender.replaceTrack(newTrack);
    });
};

async function findRoom() {
    const snap = await get(ref(db, 'rooms'));
    const rooms = snap.val() || {};
    currentRoomId = Object.keys(rooms).find(id => Object.keys(rooms[id].users || {}).length < 4) || 'Room-' + Date.now();
    
    await set(ref(db, `rooms/${currentRoomId}/users/${userId}`), { id: userId });
    onDisconnect(ref(db, `rooms/${currentRoomId}/users/${userId}`)).remove();

    onChildAdded(ref(db, `rooms/${currentRoomId}/users`), (s) => { if(s.key !== userId) createPeer(s.key, true); });
    onChildRemoved(ref(db, `rooms/${currentRoomId}/users`), (s) => {
        if(peers[s.key]) { peers[s.key].close(); delete peers[s.key]; document.getElementById(`box-${s.key}`)?.remove(); }
    });
    onChildAdded(ref(db, `rooms/${currentRoomId}/chat`), (s) => addMsg(s.val()));

    onChildAdded(ref(db, `rooms/${currentRoomId}/signals/${userId}`), async (s) => {
        const d = s.val(); if(!peers[d.from]) createPeer(d.from, false);
        const pc = peers[d.from];
        try {
            if(d.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription(d));
                const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
                push(ref(db, `rooms/${currentRoomId}/signals/${d.from}`), { from:userId, type:'answer', sdp:ans.sdp });
            } else if(d.type === 'answer') { await pc.setRemoteDescription(new RTCSessionDescription(d)); }
            else if(d.candidate) { await pc.addIceCandidate(new RTCIceCandidate(d.candidate)); }
        } catch(e) {}
    });
}

function createPeer(rid, isCaller) {
    const pc = new RTCPeerConnection(iceServers); peers[rid] = pc;
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    
    pc.onicecandidate = (e) => { 
        if(e.candidate) push(ref(db, `rooms/${currentRoomId}/signals/${rid}`), { from:userId, candidate:e.candidate.toJSON() }); 
    };

    pc.ontrack = (e) => {
        if(document.getElementById(`vid-${rid}`)) return;
        const box = document.createElement("div"); box.className = "video-box"; box.id = `box-${rid}`;
        box.innerHTML = `<video id="vid-${rid}" autoplay playsinline></video><div style="position:absolute; bottom:5px; left:5px; font-size:10px; background:rgba(0,0,0,0.5); padding:2px 5px; border-radius:4px;">Stranger</div>`;
        document.getElementById("video-grid").appendChild(box);
        setupVideo(document.getElementById(`vid-${rid}`), e.streams[0]);
    };

    if(isCaller) {
        pc.onnegotiationneeded = async () => {
            const off = await pc.createOffer(); await pc.setLocalDescription(off);
            push(ref(db, `rooms/${currentRoomId}/signals/${rid}`), { from:userId, type:'offer', sdp:off.sdp });
        };
    }
}

window.toggleMic = () => {
    const t = localStream.getAudioTracks()[0]; t.enabled = !t.enabled;
    document.getElementById("micBtn").classList.toggle("off", !t.enabled);
};
window.toggleCam = () => {
    const t = localStream.getVideoTracks()[0];
    if(t) { t.enabled = !t.enabled; document.getElementById("camBtn").classList.toggle("off", !t.enabled); }
};
window.toggleChat = () => document.getElementById("chat-sidebar").classList.toggle("open");
window.sendChat = () => {
    const v = document.getElementById("msgInput").value;
    if(v.trim()) { push(ref(db, `rooms/${currentRoomId}/chat`), { user:userId, text:v }); document.getElementById("msgInput").value = ""; }
};
function addMsg(d) {
    const div = document.createElement("div");
    div.style.cssText = `padding:10px 14px; border-radius:15px; max-width:80%; line-height:1.4; font-size:14px; ${d.user === userId ? 'align-self:flex-end; background:var(--accent);' : 'align-self:flex-start; background:var(--border);'}`;
    div.innerText = d.text; document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}
</script>
</body>
</html>
