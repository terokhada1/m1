<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶™‡ßç‡¶∞‡ßã ‡¶≠‡ßü‡ßá‡¶∏ ‡¶ì ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∞‡ßÅ‡¶Æ</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f172a; color: white; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; }
        .container { width: 100%; max-width: 600px; background: #1e293b; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); text-align: center; margin-top: 20px; }
        
        #video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
        video { width: 100%; border-radius: 12px; background: #000; object-fit: cover; height: 180px; border: 2px solid #334155; transition: 0.3s; }
        #localVideo { border-color: #0ea5e9; transform: scaleX(-1); } /* ‡¶Æ‡¶ø‡¶∞‡¶∞ ‡¶á‡¶´‡ßá‡¶ï‡ßç‡¶ü */

        input { width: 80%; padding: 12px; margin-bottom: 15px; border-radius: 10px; border: none; background: #334155; color: white; font-size: 16px; outline: none; text-align: center; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        button { padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 14px; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; }
        
        .btn-join { background: #0ea5e9; width: 100%; font-size: 16px; margin-top: 10px; }
        .btn-tool { background: #475569; }
        .btn-danger { background: #ef4444; grid-column: span 2; margin-top: 10px; }
        .active-tool { background: #0ea5e9; box-shadow: 0 0 10px #0ea5e9; }

        #user-list { text-align: left; background: #0f172a; padding: 10px; border-radius: 10px; margin-top: 15px; font-size: 14px; color: #94a3b8; }
        .status-dot { height: 8px; width: 8px; background-color: #22c55e; border-radius: 50%; display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color: #0ea5e9; margin-bottom: 10px;">BongoCall üìû</h2>
    
    <div id="setup-screen">
        <input type="text" id="userName" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
        <input type="text" id="roomInput" placeholder="‡¶∞‡ßÅ‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶Ü‡¶¶‡¶ø‡¶≤-‡ßß)">
        <button class="btn-join" onclick="joinRoom()">‡¶∞‡ßÅ‡¶Æ‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div id="call-screen" style="display: none;">
        <div id="video-grid">
            <video id="localVideo" autoplay muted playsinline></video>
        </div>

        <div id="user-list">
            <span class="status-dot"></span> ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶ï‡¶æ‡¶∞‡ßÄ: <span id="user-count">‡ßß</span> ‡¶ú‡¶®
        </div>

        <div class="controls">
            <button id="muteBtn" class="btn-tool" onclick="toggleMute()">üé§ ‡¶Æ‡¶æ‡¶á‡¶ï ‡¶ö‡¶æ‡¶≤‡ßÅ</button>
            <button id="camBtn" class="btn-tool" onclick="toggleCamera()">üì∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¨‡¶®‡ßç‡¶ß</button>
            <button id="speakerBtn" class="btn-tool" onclick="toggleSpeaker()">üîä ‡¶∏‡ßç‡¶™‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ</button>
            <button class="btn-tool" onclick="location.reload()">üîÑ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂</button>
            <button class="btn-danger" onclick="leaveRoom()">‚ùå ‡¶ï‡¶≤ ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, remove, onDisconnect, onChildRemoved } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

// ‡¶´‡¶æ‡ßü‡¶æ‡¶∞‡¶¨‡ßá‡¶∏ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó‡¶æ‡¶∞‡ßá‡¶∂‡¶® (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏ ‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶∞ ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®)
const firebaseConfig = {
    apiKey: "AIzaSyDQDrOlYu4GFuba1v1PJGlyLSIEm6Li6No",
    authDomain: "bongocall-cad70.firebaseapp.com",
    databaseURL: "https://bongocall-cad70-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bongocall-cad70",
    storageBucket: "bongocall-cad70.firebasestorage.app",
    messagingSenderId: "642949206020",
    appId: "1:642949206020:web:7329857025880de0446551"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const myId = 'u-' + Math.floor(Math.random() * 10000);

let myStream, currentRoom, peers = {}, isCamOn = false, isMuted = false;

const servers = { 
    iceServers: [
        { urls: ["stun:stun1.l.google.com:19302", "stun:stun2.l.google.com:19302"] }
    ] 
};

window.joinRoom = async () => {
    const room = document.getElementById("roomInput").value.trim().toLowerCase();
    const name = document.getElementById("userName").value.trim() || "‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ";
    if (!room) return alert("‡¶∞‡ßÅ‡¶Æ‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®");

    currentRoom = room;

    try {
        myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
        document.getElementById("localVideo").srcObject = myStream;
        
        // ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶Ö‡¶´ ‡¶∞‡¶æ‡¶ñ‡¶æ
        myStream.getVideoTracks().forEach(t => t.enabled = false);

        document.getElementById("setup-screen").style.display = "none";
        document.getElementById("call-screen").style.display = "block";

        const myRef = ref(db, `rooms/${currentRoom}/users/${myId}`);
        set(myRef, { id: myId, name: name, joinedAt: Date.now() });
        onDisconnect(myRef).remove();

        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡¶ø‡¶∏‡ßá‡¶®‡¶æ‡¶∞
        onValue(ref(db, `rooms/${currentRoom}/users`), snap => {
            const users = snap.val() || {};
            document.getElementById("user-count").innerText = Object.keys(users).length;
            Object.keys(users).forEach(uid => {
                if (uid !== myId && !peers[uid]) {
                    const isCaller = users[uid].joinedAt > users[myId].joinedAt;
                    setupPeer(uid, isCaller);
                }
            });
        });

        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶≠ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ
        onChildRemoved(ref(db, `rooms/${currentRoom}/users`), snap => {
            const uid = snap.key;
            if (peers[uid]) {
                peers[uid].close();
                delete peers[uid];
                const videoEl = document.getElementById(`vid-${uid}`);
                if (videoEl) videoEl.remove();
            }
        });

        listenForSignaling();
    } catch (err) {
        alert("‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¨‡¶æ ‡¶Æ‡¶æ‡¶á‡¶ï ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®!");
        console.error(err);
    }
};

async function setupPeer(targetId, isCaller) {
    const pc = new RTCPeerConnection(servers);
    peers[targetId] = pc;

    myStream.getTracks().forEach(track => pc.addTrack(track, myStream));

    pc.ontrack = (event) => {
        let v = document.getElementById(`vid-${targetId}`);
        if (!v) {
            v = document.createElement("video");
            v.id = `vid-${targetId}`;
            v.autoplay = true;
            v.playsinline = true;
            document.getElementById("video-grid").appendChild(v);
        }
        v.srcObject = event.streams[0];
    };

    pc.onicecandidate = e => {
        if (e.candidate) {
            push(ref(db, `rooms/${currentRoom}/signals/${targetId}/${myId}/ice`), e.candidate.toJSON());
        }
    };

    if (isCaller) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        set(ref(db, `rooms/${currentRoom}/signals/${myId}/${targetId}/offer`), { sdp: offer.sdp, type: offer.type });
    }
}

function listenForSignaling() {
    onValue(ref(db, `rooms/${currentRoom}/signals/${myId}`), snap => {
        const incomingSignals = snap.val() || {};
        for (let senderId in incomingSignals) {
            const signal = incomingSignals[senderId];
            const pc = peers[senderId];
            if (!pc) continue;

            if (signal.offer && !pc.currentRemoteDescription) {
                pc.setRemoteDescription(new RTCSessionDescription(signal.offer)).then(async () => {
                    const ans = await pc.createAnswer();
                    await pc.setLocalDescription(ans);
                    set(ref(db, `rooms/${currentRoom}/signals/${myId}/${senderId}/answer`), { sdp: ans.sdp, type: ans.type });
                    // ‡¶´‡¶ø‡¶∞‡¶§‡¶ø ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
                    set(ref(db, `rooms/${currentRoom}/signals/${senderId}/${myId}/answer`), { sdp: ans.sdp, type: ans.type });
                });
            }
            if (signal.answer && !pc.currentRemoteDescription) {
                pc.setRemoteDescription(new RTCSessionDescription(signal.answer));
            }
            if (signal.ice) {
                Object.values(signal.ice).forEach(c => pc.addIceCandidate(new RTCIceCandidate(c)).catch(()=>{}));
                // ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶ø‡¶°‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶∂‡ßá‡¶∑‡ßá ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶≠‡¶æ‡¶≤‡ßã (‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤)
            }
        }
    });
}

// --- ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
window.toggleMute = () => {
    isMuted = !isMuted;
    myStream.getAudioTracks()[0].enabled = !isMuted;
    const btn = document.getElementById("muteBtn");
    btn.innerText = isMuted ? "üîá ‡¶Æ‡¶æ‡¶á‡¶ï ‡¶¨‡¶®‡ßç‡¶ß" : "üé§ ‡¶Æ‡¶æ‡¶á‡¶ï ‡¶ö‡¶æ‡¶≤‡ßÅ";
    btn.classList.toggle("active-tool", isMuted);
};

window.toggleCamera = () => {
    isCamOn = !isCamOn;
    myStream.getVideoTracks()[0].enabled = isCamOn;
    document.getElementById("localVideo").style.display = isCamOn ? "block" : "none";
    const btn = document.getElementById("camBtn");
    btn.innerText = isCamOn ? "üì∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶ö‡¶æ‡¶≤‡ßÅ" : "üì∑ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¨‡¶®‡ßç‡¶ß";
    btn.classList.toggle("active-tool", isCamOn);
};

let speakerOff = false;
window.toggleSpeaker = () => {
    speakerOff = !speakerOff;
    const vids = document.querySelectorAll("#video-grid video");
    vids.forEach(v => {
        if(v.id !== "localVideo") v.muted = speakerOff;
    });
    const btn = document.getElementById("speakerBtn");
    btn.innerText = speakerOff ? "üîà ‡¶∏‡ßç‡¶™‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶¨‡¶®‡ßç‡¶ß" : "üîä ‡¶∏‡ßç‡¶™‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶≤‡ßÅ";
    btn.classList.toggle("active-tool", speakerOff);
};

window.leaveRoom = () => {
    if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶ï‡¶≤‡¶ü‡¶ø ‡¶∂‡ßá‡¶∑ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) location.reload();
};
</script>
</body>
</html>
