<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Stranger Chat</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        
        /* Video Grid Logic */
        #video-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .video-wrapper { position: relative; background: #000; border-radius: 10px; overflow: hidden; aspect-ratio: 4/3; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .label { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 4px; font-size: 12px; }

        #chatSection { background: #252525; border-radius: 10px; height: 300px; display: flex; flex-direction: column; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; }
        .controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        
        button { padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-start { background: #0084ff; color: white; }
        .btn-next { background: #f02849; color: white; }
        .btn-toggle { background: #444; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h2>Random Group Video Chat</h2>
    <div id="callStatus">Status: Ready</div>

    <div id="video-grid">
        <div class="video-wrapper">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="label">You</div>
        </div>
    </div>

    <div id="chatSection">
        <div id="messages"></div>
        <div style="display:flex; padding: 10px;">
            <input type="text" id="chatInput" style="flex:1; padding: 8px;" placeholder="Type message...">
            <button onclick="sendGroupMsg()">Send</button>
        </div>
    </div>

    <div class="controls">
        <button id="startBtn" class="btn-start" onclick="joinRandomGroup()">Join Random Group</button>
        <button class="btn-next" onclick="location.reload()">Leave/Next</button>
        <button class="btn-toggle" onclick="toggleCam()">Toggle Cam</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, get, onChildAdded, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
    // ... PASTE YOUR CONFIG HERE ...
    apiKey: "AIzaSyDQDrOlYu4GFuba1v1PJGlyLSIEm6Li6No",
    authDomain: "bongocall-cad70.firebaseapp.com",
    databaseURL: "https://bongocall-cad70-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bongocall-cad70",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const userId = 'user-' + Math.floor(Math.random() * 100000);
let localStream, currentRoomId;
const peers = {}; // Holds RTCPeerConnection for each person in room

const iceServers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

window.joinRandomGroup = async () => {
    document.getElementById("startBtn").disabled = true;
    
    // 1. Get Camera
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById("localVideo").srcObject = localStream;

    // 2. Find or Create Room (Max 4 people)
    const roomsRef = ref(db, 'rooms');
    const snapshot = await get(roomsRef);
    const rooms = snapshot.val() || {};
    
    currentRoomId = Object.keys(rooms).find(id => Object.keys(rooms[id].users || {}).length < 4) 
                   || 'room-' + Math.floor(Math.random() * 9999);

    // 3. Register self in room
    const userRef = ref(db, `rooms/${currentRoomId}/users/${userId}`);
    set(userRef, { id: userId, joinedAt: Date.now() });
    onDisconnect(userRef).remove();

    listenForOthers();
};

function listenForOthers() {
    const othersRef = ref(db, `rooms/${currentRoomId}/users`);
    onChildAdded(othersRef, (snapshot) => {
        const strangerId = snapshot.key;
        if (strangerId !== userId) {
            initiatePeerConnection(strangerId, true);
        }
    });

    // Listen for signaling data
    onChildAdded(ref(db, `rooms/${currentRoomId}/signals/${userId}`), async (snapshot) => {
        const { from, type, sdp, candidate } = snapshot.val();
        if (!peers[from]) initiatePeerConnection(from, false);

        if (type === 'offer') {
            await peers[from].setRemoteDescription(new RTCSessionDescription({type, sdp}));
            const answer = await peers[from].createAnswer();
            await peers[from].setLocalDescription(answer);
            push(ref(db, `rooms/${currentRoomId}/signals/${from}`), { from: userId, type: 'answer', sdp: answer.sdp });
        } else if (type === 'answer') {
            await peers[from].setRemoteDescription(new RTCSessionDescription({type, sdp}));
        } else if (candidate) {
            peers[from].addIceCandidate(new RTCIceCandidate(candidate));
        }
    });
}

async function initiatePeerConnection(remoteId, isCaller) {
    if (peers[remoteId]) return;

    const pc = new RTCPeerConnection(iceServers);
    peers[remoteId] = pc;

    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    pc.ontrack = (e) => {
        if (document.getElementById(`video-${remoteId}`)) return;
        const container = document.getElementById("video-grid");
        const wrapper = document.createElement("div");
        wrapper.className = "video-wrapper";
        wrapper.id = `video-wrapper-${remoteId}`;
        wrapper.innerHTML = `<video id="video-${remoteId}" autoplay playsinline></video><div class="label">Stranger</div>`;
        container.appendChild(wrapper);
        document.getElementById(`video-${remoteId}`).srcObject = e.streams[0];
    };

    pc.onicecandidate = (e) => {
        if (e.candidate) push(ref(db, `rooms/${currentRoomId}/signals/${remoteId}`), { from: userId, candidate: e.candidate.toJSON() });
    };

    if (isCaller) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        push(ref(db, `rooms/${currentRoomId}/signals/${remoteId}`), { from: userId, type: 'offer', sdp: offer.sdp });
    }
}

window.toggleCam = () => {
    const videoTrack = localStream.getVideoTracks()[0];
    videoTrack.enabled = !videoTrack.enabled;
};

// Simplified chat for groups
window.sendGroupMsg = () => {
    const text = document.getElementById("chatInput").value;
    push(ref(db, `rooms/${currentRoomId}/chat`), { user: userId, text });
    document.getElementById("chatInput").value = "";
};

// Listen for group chat messages
// (Add onValue for `rooms/${currentRoomId}/chat` similar to your previous code)
</script>
</body>
</html>
