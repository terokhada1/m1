<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Stranger Video - Fixed</title>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --border: #30363d; --primary: #238636; --danger: #da3633; --accent: #2f81f7; }
        
        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg); color: white; margin: 0; 
            display: flex; flex-direction: column; 
            height: 100vh; height: -webkit-fill-available;
            overflow: hidden; 
        }

        #home-screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .mode-card { background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid var(--border); text-align: center; width: 85%; max-width: 350px; }

        #main-container { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; position: relative; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; padding: 10px; overflow-y: auto; align-content: start; }
        .video-box { position: relative; background: #000; border-radius: 12px; overflow: hidden; aspect-ratio: 3/4; border: 1px solid var(--border); }
        video { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }

        .controls { 
            background: #161b22; padding: 10px 8px;
            padding-bottom: calc(15px + env(safe-area-inset-bottom)); 
            display: flex; justify-content: center; gap: 8px; 
            border-top: 1px solid var(--border); z-index: 1000;
        }

        .btn { 
            width: 46px; height: 46px; border-radius: 50%; border: none; cursor: pointer; 
            background: #30363d; color: white; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; font-size: 16px; flex-shrink: 0;
        }

        .btn span { font-size: 7px; margin-top: 2px; font-weight: bold; }
        .btn.off { background: var(--danger) !important; }
        .btn.active-share { background: var(--primary) !important; }
        .btn-leave { background: var(--danger); width: 55px; border-radius: 12px; }

        #chat-sidebar { position: absolute; inset: 0; background: var(--card); z-index: 500; display: none; flex-direction: column; }
        #chat-sidebar.open { display: flex; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="home-screen">
        <div class="mode-card">
            <h2 style="margin-top:0">Stranger Video</h2>
            <button class="btn" style="width:100%; border-radius:12px; background:var(--accent); font-size: 1.1rem; height: 50px;" onclick="startApp()">ðŸ“¹ Join Video Chat</button>
        </div>
    </div>

    <div id="main-container">
        <div id="video-grid">
            <div class="video-box" id="localBox">
                <video id="localVideo" autoplay muted playsinline></video>
            </div>
        </div>

        <div id="chat-sidebar">
            <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                <span>Live Chat</span>
                <button onclick="toggleChat()" style="background:#30363d; border:none; color:white; border-radius:50%; width:30px; height:30px;">âœ•</button>
            </div>
            <div id="messages" style="flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px;"></div>
            <div style="padding:10px; display:flex; gap:5px; border-top:1px solid var(--border); background:var(--card);">
                <input type="text" id="msgInput" style="flex:1; padding:12px; border-radius:8px; border:none; background:#000; color:white;" placeholder="Type message...">
                <button onclick="sendChat()" style="background:var(--accent); border:none; color:white; border-radius:8px; padding:0 12px;">Send</button>
            </div>
        </div>
    </div>

    <div id="actionButtons" class="controls hidden">
        <button id="micBtn" class="btn" onclick="toggleMic()">ðŸŽ¤<span>Mic</span></button>
        <button id="camBtn" class="btn" onclick="toggleCam()">ðŸ“·<span>Cam</span></button>
        <button id="shareBtn" class="btn" onclick="toggleScreenShare()">ðŸ“º<span>Share</span></button>
        <button id="flipBtn" class="btn" onclick="flipCamera()">ðŸ”„<span>Flip</span></button>
        <button id="chatBtn" class="btn" onclick="toggleChat()">ðŸ’¬<span>Chat</span></button>
        <button class="btn btn-leave" onclick="location.reload()">âœ–<span>Exit</span></button>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, push, onChildAdded, onChildRemoved, get, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDQDrOlYu4GFuba1v1PJGlyLSIEm6Li6No",
    authDomain: "bongocall-cad70.firebaseapp.com",
    databaseURL: "https://bongocall-cad70-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bongocall-cad70",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const userId = 'User-' + Math.floor(Math.random() * 9000);
const iceServers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
let localStream, screenStream, currentRoomId, peers = {}, currentFacingMode = "user", isSharing = false;

// --- CRITICAL BLACK SCREEN FIX: RECURSIVE PLAY ---
const forcePlay = (videoEl, stream) => {
    videoEl.srcObject = stream;
    const attemptPlay = () => {
        videoEl.play().catch(() => {
            console.log("Retrying play...");
            setTimeout(attemptPlay, 1000); // Retry every second if blocked
        });
    };
    videoEl.onloadedmetadata = attemptPlay;
};

window.startApp = async () => {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ 
            audio: true, 
            video: { facingMode: currentFacingMode, width: { ideal: 640 }, height: { ideal: 480 } } 
        });
        forcePlay(document.getElementById("localVideo"), localStream);
        document.getElementById("home-screen").style.display = "none";
        document.getElementById("actionButtons").classList.remove("hidden");
        findRoom();
    } catch (e) { alert("Camera Error. Please refresh and allow access."); }
};

window.toggleScreenShare = async () => {
    try {
        if (!isSharing) {
            screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            const screenTrack = screenStream.getVideoTracks()[0];
            replaceTrack(screenTrack);
            forcePlay(document.getElementById("localVideo"), screenStream);
            screenTrack.onended = stopSharing;
            document.getElementById("shareBtn").classList.add("active-share");
            isSharing = true;
        } else { stopSharing(); }
    } catch (e) { console.error(e); }
};

function stopSharing() {
    if (screenStream) screenStream.getTracks().forEach(t => t.stop());
    const videoTrack = localStream.getVideoTracks()[0];
    replaceTrack(videoTrack);
    forcePlay(document.getElementById("localVideo"), localStream);
    document.getElementById("shareBtn").classList.remove("active-share");
    isSharing = false;
}

function replaceTrack(newTrack) {
    Object.values(peers).forEach(pc => {
        const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
        if (sender) sender.replaceTrack(newTrack);
    });
}

window.flipCamera = async () => {
    if (isSharing) return;
    const oldTrack = localStream.getVideoTracks()[0];
    currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
    const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
    const newTrack = newStream.getVideoTracks()[0];
    localStream.removeTrack(oldTrack);
    oldTrack.stop();
    localStream.addTrack(newTrack);
    forcePlay(document.getElementById("localVideo"), localStream);
    replaceTrack(newTrack);
};

async function findRoom() {
    const snap = await get(ref(db, 'rooms'));
    const rooms = snap.val() || {};
    currentRoomId = Object.keys(rooms).find(id => Object.keys(rooms[id].users || {}).length < 4) || 'Room-' + Date.now();
    await set(ref(db, `rooms/${currentRoomId}/users/${userId}`), { id: userId });
    onDisconnect(ref(db, `rooms/${currentRoomId}/users/${userId}`)).remove();
    onChildAdded(ref(db, `rooms/${currentRoomId}/users`), (s) => { if(s.key !== userId) createPeer(s.key, true); });
    onChildRemoved(ref(db, `rooms/${currentRoomId}/users`), (s) => {
        if(peers[s.key]) { peers[s.key].close(); delete peers[s.key]; document.getElementById(`box-${s.key}`)?.remove(); }
    });
    onChildAdded(ref(db, `rooms/${currentRoomId}/chat`), (s) => addMsg(s.val()));
    onChildAdded(ref(db, `rooms/${currentRoomId}/signals/${userId}`), async (s) => {
        const d = s.val(); if(!peers[d.from]) createPeer(d.from, false);
        const pc = peers[d.from];
        try {
            if(d.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription(d));
                const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
                push(ref(db, `rooms/${currentRoomId}/signals/${d.from}`), { from:userId, type:'answer', sdp:ans.sdp });
            } else if(d.type === 'answer') { await pc.setRemoteDescription(new RTCSessionDescription(d)); }
            else if(d.candidate) { await pc.addIceCandidate(new RTCIceCandidate(d.candidate)); }
        } catch(e) {}
    });
}

function createPeer(rid, isCaller) {
    const pc = new RTCPeerConnection(iceServers); peers[rid] = pc;
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
    pc.onicecandidate = (e) => { if(e.candidate) push(ref(db, `rooms/${currentRoomId}/signals/${rid}`), { from:userId, candidate:e.candidate.toJSON() }); };
    pc.ontrack = (e) => {
        if(document.getElementById(`vid-${rid}`)) return;
        const box = document.createElement("div"); box.className = "video-box"; box.id = `box-${rid}`;
        box.innerHTML = `<video id="vid-${rid}" autoplay playsinline></video>`;
        document.getElementById("video-grid").appendChild(box);
        forcePlay(document.getElementById(`vid-${rid}`), e.streams[0]);
    };
    if(isCaller) {
        pc.onnegotiationneeded = async () => {
            const off = await pc.createOffer(); await pc.setLocalDescription(off);
            push(ref(db, `rooms/${currentRoomId}/signals/${rid}`), { from:userId, type:'offer', sdp:off.sdp });
        };
    }
}

window.toggleMic = () => {
    const t = localStream.getAudioTracks()[0]; t.enabled = !t.enabled;
    document.getElementById("micBtn").classList.toggle("off", !t.enabled);
};
window.toggleCam = () => {
    const t = localStream.getVideoTracks()[0];
    if(t) { t.enabled = !t.enabled; document.getElementById("camBtn").classList.toggle("off", !t.enabled); }
};
window.toggleChat = () => document.getElementById("chat-sidebar").classList.toggle("open");
window.sendChat = () => {
    const v = document.getElementById("msgInput").value;
    if(v.trim()) { push(ref(db, `rooms/${currentRoomId}/chat`), { user:userId, text:v }); document.getElementById("msgInput").value = ""; }
};
function addMsg(d) {
    const div = document.createElement("div");
    div.style.cssText = `padding:8px 12px; border-radius:12px; max-width:85%; font-size:14px; line-height:1.4; ${d.user === userId ? 'align-self:flex-end; background:var(--accent);' : 'align-self:flex-start; background:var(--border);'}`;
    div.innerText = d.text; document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
}
</script>
</body>
</html>
