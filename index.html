<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Voice Room</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #121212; color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 450px; background: #1e1e1e; padding: 25px; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.5); text-align: center; }
        
        input { width: 80%; padding: 12px; margin: 15px 0; border-radius: 8px; border: 1px solid #333; background: #2b2b2b; color: white; font-size: 16px; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        .btn-join { background: #0084ff; color: white; width: 100%; font-size: 16px; }
        .btn-mute { background: #333; color: white; }
        .btn-speaker { background: #333; color: white; }
        .btn-leave { background: #f02849; color: white; grid-column: span 2; margin-top: 10px; }
        
        #participant-list { margin-top: 25px; text-align: left; background: #252525; padding: 15px; border-radius: 10px; min-height: 100px; }
        .user-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #333; }
        .status-dot { height: 10px; width: 10px; background: #31a24c; border-radius: 50%; display: inline-block; margin-right: 8px; }
        
        .active-speaker { border-left: 3px solid #0084ff; padding-left: 10px; transition: 0.3s; }
    </style>
</head>
<body>

<div class="container">
    <h2>üéôÔ∏è Voice Lobby</h2>
    
    <div id="login-screen">
        <input type="text" id="roomInput" placeholder="Enter Room Name...">
        <button class="btn-join" onclick="joinRoom()">Join Group Call</button>
    </div>

    <div id="call-screen" style="display: none;">
        <p id="room-display" style="color: #0084ff; font-weight: bold;"></p>
        
        <div id="participant-list">
            <small style="color: #888;">Participants</small>
            <div id="users-container"></div>
        </div>

        <div class="controls">
            <button id="muteBtn" class="btn-mute" onclick="toggleMute()">üé§ Mic On</button>
            <button id="speakerBtn" class="btn-speaker" onclick="toggleSpeaker()">üîä Speaker On</button>
            <button class="btn-leave" onclick="leaveRoom()">‚ùå Leave Room</button>
        </div>
    </div>
</div>

<div id="remote-audios" style="display:none;"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, remove, onDisconnect, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDQDrOlYu4GFuba1v1PJGlyLSIEm6Li6No",
    authDomain: "bongocall-cad70.firebaseapp.com",
    databaseURL: "https://bongocall-cad70-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bongocall-cad70",
    storageBucket: "bongocall-cad70.firebasestorage.app",
    messagingSenderId: "642949206020",
    appId: "1:642949206020:web:7329857025880de0446551"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const myId = 'user-' + Math.floor(Math.random() * 10000);
let myStream;
let peers = {}; 
let isSpeakerOn = true;
let currentRoom = null;

const servers = { iceServers: [{ urls: ["stun:stun1.l.google.com:19302", "stun:stun2.l.google.com:19302"] }] };

// --- Join Room Logic ---
window.joinRoom = async () => {
    const roomName = document.getElementById("roomInput").value.trim().toLowerCase();
    if (!roomName) return alert("Please enter a room name");
    
    currentRoom = roomName;

    try {
        myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    } catch (e) {
        alert("Microphone access is required for group calls.");
        return;
    }

    // UI Updates
    document.getElementById("login-screen").style.display = "none";
    document.getElementById("call-screen").style.display = "block";
    document.getElementById("room-display").innerText = "ROOM: " + currentRoom;

    // Presence
    const userRef = ref(db, `rooms/${currentRoom}/users/${myId}`);
    set(userRef, { id: myId, joinedAt: Date.now() });
    onDisconnect(userRef).remove();

    // Listen for users
    onValue(ref(db, `rooms/${currentRoom}/users`), (snapshot) => {
        const users = snapshot.val() || {};
        renderUserList(users);

        Object.keys(users).forEach(userId => {
            if (userId !== myId && !peers[userId]) {
                // If user is newer than me, I am the caller
                const isCaller = users[userId].joinedAt > users[myId].joinedAt;
                setupPeer(userId, isCaller);
            }
        });
    });

    listenForSignaling();
};

// --- WebRTC Peer Logic ---
async function setupPeer(targetId, isCaller) {
    const pc = new RTCPeerConnection(servers);
    peers[targetId] = pc;

    myStream.getTracks().forEach(track => pc.addTrack(track, myStream));

    pc.ontrack = (event) => {
        let audio = document.getElementById(`audio-${targetId}`);
        if (!audio) {
            audio = document.createElement("audio");
            audio.id = `audio-${targetId}`;
            audio.autoplay = true;
            audio.volume = isSpeakerOn ? 1.0 : 0.0;
            document.getElementById("remote-audios").appendChild(audio);
        }
        audio.srcObject = event.streams[0];
    };

    pc.onicecandidate = (e) => {
        if (e.candidate) {
            push(ref(db, `rooms/${currentRoom}/signals/${targetId}/${myId}/ice`), e.candidate.toJSON());
        }
    };

    if (isCaller) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        set(ref(db, `rooms/${currentRoom}/signals/${myId}/${targetId}/offer`), { sdp: offer.sdp, type: offer.type });
    }
}

function listenForSignaling() {
    onValue(ref(db, `rooms/${currentRoom}/signals`), (snapshot) => {
        const signals = snapshot.val() || {};
        for (let senderId in signals) {
            if (senderId === myId) continue;
            const myIncoming = signals[senderId][myId];
            if (!myIncoming) continue;

            const pc = peers[senderId];
            if (!pc) continue;

            if (myIncoming.offer && !pc.currentRemoteDescription) {
                pc.setRemoteDescription(new RTCSessionDescription(myIncoming.offer)).then(async () => {
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    set(ref(db, `rooms/${currentRoom}/signals/${myId}/${senderId}/answer`), { sdp: answer.sdp, type: answer.type });
                });
            }

            if (myIncoming.answer && !pc.currentRemoteDescription) {
                pc.setRemoteDescription(new RTCSessionDescription(myIncoming.answer));
            }

            if (myIncoming.ice) {
                Object.values(myIncoming.ice).forEach(cand => pc.addIceCandidate(new RTCIceCandidate(cand)).catch(()=>{}));
            }
        }
    });
}

// --- Mic & Speaker Fixes ---
window.toggleMute = () => {
    const track = myStream.getAudioTracks()[0];
    track.enabled = !track.enabled;
    const btn = document.getElementById("muteBtn");
    btn.innerText = track.enabled ? "üé§ Mic On" : "üîá Mic Muted";
    btn.style.background = track.enabled ? "#333" : "#f02849";
};

window.toggleSpeaker = () => {
    isSpeakerOn = !isSpeakerOn;
    const audios = document.querySelectorAll("audio");
    audios.forEach(a => a.volume = isSpeakerOn ? 1.0 : 0.0);
    
    const btn = document.getElementById("speakerBtn");
    btn.innerText = isSpeakerOn ? "üîä Speaker On" : "üîà Earpiece/Mute";
    btn.style.background = isSpeakerOn ? "#333" : "#555";
};

function renderUserList(users) {
    const container = document.getElementById("users-container");
    container.innerHTML = "";
    Object.keys(users).forEach(id => {
        const div = document.createElement("div");
        div.className = "user-row";
        div.innerHTML = `<span><span class="status-dot"></span>${id === myId ? "You (Me)" : "Stranger " + id.split('-')[1]}</span>`;
        container.appendChild(div);
    });
}

window.leaveRoom = () => {
    location.reload();
};
</script>
</body>
</html>
