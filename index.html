<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Audio Room</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; display: flex; justify-content: center; padding: 20px; }
        .card { background: #2a2a2a; padding: 30px; border-radius: 20px; width: 100%; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        input { width: 80%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; }
        button { padding: 12px 24px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #0084ff; color: white; margin: 5px; }
        .leave-btn { background: #f02849; }
        #participant-list { margin-top: 20px; text-align: left; background: #333; padding: 15px; border-radius: 10px; }
        .user-tag { display: inline-block; background: #444; padding: 5px 12px; margin: 5px; border-radius: 20px; font-size: 14px; border: 1px solid #555; }
        .visualizer { height: 5px; background: #0084ff; width: 0%; transition: width 0.1s; margin-top: 5px; border-radius: 2px; }
    </style>
</head>
<body>

<div class="card">
    <h2>üéôÔ∏è Group Audio Room</h2>
    <div id="setup">
        <input type="text" id="roomInput" placeholder="Enter Room Name (e.g. 'gaming')">
        <br>
        <button onclick="joinRoom()">Join Voice Room</button>
    </div>

    <div id="roomControls" style="display:none;">
        <h3 id="activeRoom">Room: None</h3>
        <div id="participant-list">
            <strong>In the call:</strong><br>
            <div id="users"></div>
        </div>
        <br>
        <button id="muteBtn" onclick="toggleMute()">Mute Mic</button>
        <button class="leave-btn" onclick="leaveRoom()">Leave Call</button>
    </div>
    
    <div id="remote-audios"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue, push, remove, onDisconnect, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDQDrOlYu4GFuba1v1PJGlyLSIEm6Li6No",
    authDomain: "bongocall-cad70.firebaseapp.com",
    databaseURL: "https://bongocall-cad70-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bongocall-cad70",
    storageBucket: "bongocall-cad70.firebasestorage.app",
    messagingSenderId: "642949206020",
    appId: "1:642949206020:web:7329857025880de0446551"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const myId = 'user-' + Math.floor(Math.random() * 10000);
let myStream;
let peers = {}; // Stores RTCPeerConnection for every other user
let currentRoom = null;

const servers = { iceServers: [{ urls: ["stun:stun1.l.google.com:19302", "stun:stun2.l.google.com:19302"] }] };

window.joinRoom = async () => {
    const roomName = document.getElementById("roomInput").value.trim();
    if (!roomName) return alert("Enter a room name");
    currentRoom = roomName;

    // 1. Get Audio
    myStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    
    // 2. Register presence
    const myRef = ref(db, `rooms/${currentRoom}/users/${myId}`);
    set(myRef, { id: myId, joinedAt: Date.now() });
    onDisconnect(myRef).remove();

    document.getElementById("setup").style.display = "none";
    document.getElementById("roomControls").style.display = "block";
    document.getElementById("activeRoom").innerText = `Room: ${currentRoom}`;

    // 3. Listen for other users
    onValue(ref(db, `rooms/${currentRoom}/users`), async (snapshot) => {
        const users = snapshot.val() || {};
        updateUserList(users);

        for (let userId in users) {
            if (userId !== myId && !peers[userId]) {
                // If a new user joined who joined AFTER me, I call them
                if (users[userId].joinedAt > users[myId].joinedAt) {
                    initiatePeerConnection(userId, true);
                } else {
                    initiatePeerConnection(userId, false);
                }
            }
        }
    });

    // 4. Listen for signaling (Offers/Answers/ICE)
    listenForSignaling();
};

async function initiatePeerConnection(targetId, isCaller) {
    const pc = new RTCPeerConnection(servers);
    peers[targetId] = pc;

    myStream.getTracks().forEach(track => pc.addTrack(track, myStream));

    pc.ontrack = (event) => {
        let audio = document.getElementById(`audio-${targetId}`);
        if (!audio) {
            audio = document.createElement("audio");
            audio.id = `audio-${targetId}`;
            audio.autoplay = true;
            document.getElementById("remote-audios").appendChild(audio);
        }
        audio.srcObject = event.streams[0];
    };

    pc.onicecandidate = (e) => {
        if (e.candidate) {
            push(ref(db, `rooms/${currentRoom}/signals/${targetId}/${myId}/ice`), e.candidate.toJSON());
        }
    };

    if (isCaller) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        set(ref(db, `rooms/${currentRoom}/signals/${myId}/${targetId}/offer`), { sdp: offer.sdp, type: offer.type });
    }
}

function listenForSignaling() {
    // Listen for offers sent TO me
    onValue(ref(db, `rooms/${currentRoom}/signals`), (snapshot) => {
        const allSignals = snapshot.val() || {};

        for (let senderId in allSignals) {
            if (senderId === myId) continue;
            
            const mySignals = allSignals[senderId][myId];
            if (!mySignals) continue;

            const pc = peers[senderId];
            if (!pc) return;

            // Handle Offer
            if (mySignals.offer && !pc.currentRemoteDescription) {
                pc.setRemoteDescription(new RTCSessionDescription(mySignals.offer)).then(async () => {
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    set(ref(db, `rooms/${currentRoom}/signals/${myId}/${senderId}/answer`), { sdp: answer.sdp, type: answer.type });
                });
            }

            // Handle Answer
            if (mySignals.answer && !pc.currentRemoteDescription) {
                pc.setRemoteDescription(new RTCSessionDescription(mySignals.answer));
            }

            // Handle ICE
            if (mySignals.ice) {
                Object.values(mySignals.ice).forEach(cand => {
                    pc.addIceCandidate(new RTCIceCandidate(cand)).catch(() => {});
                });
            }
        }
    });
}

function updateUserList(users) {
    const container = document.getElementById("users");
    container.innerHTML = "";
    Object.keys(users).forEach(id => {
        const span = document.createElement("span");
        span.className = "user-tag";
        span.innerText = id === myId ? "You" : "Stranger";
        container.appendChild(span);
    });
}

window.toggleMute = () => {
    const track = myStream.getAudioTracks()[0];
    track.enabled = !track.enabled;
    document.getElementById("muteBtn").innerText = track.enabled ? "Mute Mic" : "Unmute Mic";
    document.getElementById("muteBtn").style.background = track.enabled ? "#0084ff" : "#555";
};

window.leaveRoom = () => {
    location.reload();
};
</script>
</body>
</html>
