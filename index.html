<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stranger Group Chat - Debug Mode</title>
    <style>
        body { font-family: sans-serif; background: #0b0e14; color: white; text-align: center; margin: 0; padding: 20px; }
        #video-grid { display: grid; grid-template-columns: 1fr; gap: 10px; max-width: 500px; margin: auto; }
        .video-box { background: #1c212c; border-radius: 15px; overflow: hidden; aspect-ratio: 4/3; position: relative; border: 1px solid #30363d; }
        video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .label { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 5px; font-size: 12px; }
        
        /* Debug Console */
        #debug-log { background: #000; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; height: 100px; overflow-y: auto; text-align: left; margin-top: 20px; border: 1px solid #333; }
        .btn { padding: 15px 40px; border-radius: 30px; border: none; background: #238636; color: white; font-weight: bold; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

    <h3>Stranger Group Chat</h3>
    <div id="video-grid">
        <div class="video-box">
            <video id="localVideo" autoplay muted playsinline></video>
            <div class="label">You</div>
        </div>
    </div>

    <button id="joinBtn" class="btn" onclick="startApp()">Join Chat</button>

    <div id="debug-log">System: Ready. Press Join.</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, push, onChildAdded, get, onDisconnect } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyDQDrOlYu4GFuba1v1PJGlyLSIEm6Li6No",
    authDomain: "bongocall-cad70.firebaseapp.com",
    databaseURL: "https://bongocall-cad70-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bongocall-cad70",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const userId = 'user-' + Math.floor(Math.random() * 9000);
const iceServers = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }, { urls: "stun:stun1.l.google.com:19302" }] };
let localStream, currentRoomId, peers = {};

function log(msg) {
    const console = document.getElementById("debug-log");
    console.innerHTML += `<br>> ${msg}`;
    console.scrollTop = console.scrollHeight;
}

window.startApp = async () => {
    try {
        log("Requesting Camera...");
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById("localVideo").srcObject = localStream;
        document.getElementById("joinBtn").style.display = "none";
        log("Camera OK. Finding room...");
        joinRoom();
    } catch (e) {
        log("ERROR: Camera denied or not found!");
        alert("Please allow Camera and Mic permission!");
    }
};

async function joinRoom() {
    const roomsRef = ref(db, 'rooms');
    const snap = await get(roomsRef);
    const rooms = snap.val() || {};

    // Find a room with space
    currentRoomId = Object.keys(rooms).find(id => Object.keys(rooms[id].users || {}).length < 4) || 'room-' + Math.floor(Math.random() * 99);
    
    log(`Joining Room: ${currentRoomId}`);
    const userRef = ref(db, `rooms/${currentRoomId}/users/${userId}`);
    set(userRef, { id: userId });
    onDisconnect(userRef).remove();

    // Listen for others
    onChildAdded(ref(db, `rooms/${currentRoomId}/users`), (s) => {
        if (s.key !== userId) {
            log(`Stranger found: ${s.key}. Connecting...`);
            initiatePeer(s.key, true);
        }
    });

    // Listen for signals
    onChildAdded(ref(db, `rooms/${currentRoomId}/signals/${userId}`), async (s) => {
        const data = s.val();
        if (!peers[data.from]) initiatePeer(data.from, false);
        
        try {
            if (data.type === 'offer') {
                await peers[data.from].setRemoteDescription(new RTCSessionDescription(data));
                const ans = await peers[data.from].createAnswer();
                await peers[data.from].setLocalDescription(ans);
                push(ref(db, `rooms/${currentRoomId}/signals/${data.from}`), { from: userId, type: 'answer', sdp: ans.sdp });
            } else if (data.type === 'answer') {
                await peers[data.from].setRemoteDescription(new RTCSessionDescription(data));
            } else if (data.candidate) {
                await peers[data.from].addIceCandidate(new RTCIceCandidate(data.candidate));
            }
        } catch (err) { log("Signaling Error: " + err.message); }
    });
}

function initiatePeer(remoteId, isCaller) {
    if (peers[remoteId]) return;
    const pc = new RTCPeerConnection(iceServers);
    peers[remoteId] = pc;

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.ontrack = (e) => {
        log("SUCCESS: Stranger video track received!");
        if (document.getElementById(`vid-${remoteId}`)) return;
        const box = document.createElement("div");
        box.className = "video-box";
        box.innerHTML = `<video id="vid-${remoteId}" autoplay playsinline></video><div class="label">Stranger</div>`;
        document.getElementById("video-grid").appendChild(box);
        document.getElementById(`vid-${remoteId}`).srcObject = e.streams[0];
    };

    pc.onicecandidate = (e) => {
        if (e.candidate) push(ref(db, `rooms/${currentRoomId}/signals/${remoteId}`), { from: userId, candidate: e.candidate.toJSON() });
    };

    if (isCaller) {
        pc.onnegotiationneeded = async () => {
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            push(ref(db, `rooms/${currentRoomId}/signals/${remoteId}`), { from: userId, type: 'offer', sdp: offer.sdp });
        };
    }
}
</script>
</body>
</html>
